name: UChicago
on:
  workflow_dispatch:
  push:

jobs:
  rucio:
    runs-on: arc-runner-set-uchicago
    steps:
      - run: echo "ðŸŽ‰ This job uses runner scale set runners!"

      - uses: actions/checkout@v5

      - name: Setup Globus credentials securely
        run: |
          mkdir -p ~/.globus

          # Write certificate preserving newlines
          cat > ~/.globus/usercert.pem << 'EOF'
          ${{ secrets.VOMS_USERCERT }}
          EOF

          # Write key preserving newlines
          cat > ~/.globus/userkey.pem << 'EOF'
          ${{ secrets.VOMS_USERKEY }}
          EOF

          sed -n '1,5p' ~/.globus/usercert.pem

          # Set permissions
          chmod 644 ~/.globus/usercert.pem
          chmod 600 ~/.globus/userkey.pem
          ls -lavh ~/.globus/
        # Ensure secrets are masked in logs
        shell: bash

      - name: Debug
        run: |
          printenv
          type source
        shell: bash

      - name: Rucio
        run: Rucio/rucio_script.sh uchicago
        shell: bash
        env:
          VOMS_PASSWORD: ${{ secrets.VOMS_PASSWORD }}

  evnt:
    runs-on: arc-runner-set-uchicago
    steps:
      - run: echo "ðŸŽ‰ This job uses runner scale set runners!"

      - uses: actions/checkout@v5

      - name: Install libcrypt.so.2
        run: |
          sudo apt-get update || true
          sudo apt-get install -y libxcrypt0 || true
          sudo apt-get install -y libcrypt1  || true
          CANDIDATE=$(ls /usr/lib/x86_64-linux-gnu/libcrypt.so.* 2>/dev/null | head -n 1 || true)
          if [ -n "$CANDIDATE" ] && [ ! -f /usr/lib/x86_64-linux-gnu/libcrypt.so.2 ]; then
            echo "Using $CANDIDATE as libcrypt.so.2"
            sudo ln -s "$CANDIDATE" /usr/lib/x86_64-linux-gnu/libcrypt.so.2
          fi
          ls -l /usr/lib/x86_64-linux-gnu/libcrypt.so*

      - name: EVNT
        run: ./EVNT/UC/Native/run_evnt_native_batch.sh
        working-directory: .
        shell: bash
